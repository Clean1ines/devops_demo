#!/usr/bin/env bash
set -e

echo "ğŸ” Pre-commit security scan..."

# Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ¸Ğ³Ğ½Ğ°Ñ‚ÑƒÑ€Ñ‹ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ² (Ğ±ĞµĞ· Ğ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğ¹)
BLOCK_PATTERNS='-----BEGIN( RSA)? PRIVATE KEY-----|AKIA[0-9A-Z]{16}|SECRET_KEY[[:space:]]*=|TOKEN[[:space:]]*=|PASSWORD[[:space:]]*='

FILES=$(git diff --cached --name-only)

for f in $FILES; do
  # Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ ÑĞ°Ğ¼ Ñ…ÑƒĞº
  if [[ "$f" == ".githooks/pre-commit" ]]; then
    continue
  fi

  # ĞµÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ² Ğ¸Ğ½Ğ´ĞµĞºÑĞµ â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
  if ! git show ":$f" >/dev/null 2>&1; then
    continue
  fi

  # Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµĞºÑÑ‚
  if ! git show ":$f" | file - | grep -qi text; then
    continue
  fi

  if git show ":$f" | grep -Ei "$BLOCK_PATTERNS" >/dev/null; then
    echo "âŒ SECURITY BLOCK: Secret detected in $f"
    exit 1
  fi
done

echo "âœ… Security scan passed"
exit 0
